<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;700;900&display=swap" rel="stylesheet">
<title>Incantation Practice</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  overflow: hidden;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Noto Serif JP", "Hiragino Mincho ProN", "Yu Mincho", serif;
  transition: background-color 0.3s, color 0.3s;
  user-select: none;
}

body.dark {
  background: #0d0b07;
  color: #e8dcc8;
  background-image: radial-gradient(ellipse at center, #1a1510 0%, #0d0b07 70%);
}
body.light {
  background: #f0e8d8;
  color: #2a1f0e;
  background-image: radial-gradient(ellipse at center, #f5efe0 0%, #e0d5c0 70%);
}

.phrase {
  font-size: 7vw;
  font-weight: 900;
  letter-spacing: 0.05em;
  text-align: center;
  padding: 0 5vw;
  line-height: 1.4;
  opacity: 0;
  transition: opacity 1s ease;
}

.phrase.visible { opacity: 1; }

body.dark .phrase .ch { color: #2a2318; }
body.dark .phrase .ch.active { color: #e8c868; text-shadow: 0 0 20px rgba(232, 200, 104, 0.4); }
body.light .phrase .ch { color: #d5cbb8; }
body.light .phrase .ch.active { color: #6b4c1e; }

/* LB mode styles */
.lb-container {
  text-align: center;
  padding: 0 5vw;
  opacity: 0;
  transition: opacity 0.8s ease;
}

.lb-container.visible { opacity: 1; }

.lb-label {
  font-size: 2.5vw;
  font-weight: 300;
  opacity: 0.4;
  margin-bottom: 2vh;
  letter-spacing: 0.2em;
}

.lb-text {
  font-size: 5vw;
  font-weight: 700;
  line-height: 1.4;
  margin-bottom: 4vh;
}

.lb-action {
  font-size: 6vw;
  font-weight: 900;
  opacity: 0;
  transition: opacity 0.8s ease;
  margin-top: 2vh;
}

.lb-action.visible { opacity: 1; }

/* LB mode color: cursed red for limiting beliefs */
body.dark .lb-text { color: #a03030; text-shadow: 0 0 15px rgba(160, 48, 48, 0.3); }
body.light .lb-text { color: #8b2020; }

body.dark .lb-action.break { color: #c87830; text-shadow: 0 0 12px rgba(200, 120, 48, 0.3); }
body.light .lb-action.break { color: #8b5a1e; }

body.dark .lb-action.easy { color: #d4a840; text-shadow: 0 0 12px rgba(212, 168, 64, 0.3); }
body.light .lb-action.easy { color: #8b7320; }

body.dark .lb-action.lie { color: #50b850; text-shadow: 0 0 12px rgba(80, 184, 80, 0.3); }
body.light .lb-action.lie { color: #2d6b2d; }

/* Strikethrough animation for LB */
.lb-text.struck {
  text-decoration: line-through;
  text-decoration-thickness: 0.08em;
  opacity: 0.3;
  transition: opacity 0.6s ease, text-decoration 0.3s ease;
}

/* EB reveal */
.eb-reveal {
  font-size: 6vw;
  font-weight: 900;
  opacity: 0;
  transition: opacity 1s ease;
  line-height: 1.4;
}

.eb-reveal.visible { opacity: 1; }

body.dark .eb-reveal { color: #e8c868; text-shadow: 0 0 25px rgba(232, 200, 104, 0.5); }
body.light .eb-reveal { color: #6b4c1e; }

/* Counter */
.lb-counter {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 16px;
  opacity: 0.3;
  letter-spacing: 0.3em;
}

.timer {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 100;
  font-size: 48px;
  font-weight: 300;
  font-variant-numeric: tabular-nums;
  opacity: 0.25;
  transition: opacity 0.3s;
}

.timer:hover { opacity: 1; }

.timer.finished {
  animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.25; }
  50% { opacity: 1; }
}

.progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  background: currentColor;
  opacity: 0.3;
  transition: width 1s linear;
}

.controls {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 100;
  display: flex;
  gap: 10px;
  opacity: 0.15;
  transition: opacity 0.3s;
}

.speed-control {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  opacity: 0.15;
  transition: opacity 0.3s;
}

.hint {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 100;
  font-size: 12px;
  opacity: 0.15;
  transition: opacity 0.3s;
}

body.dark .hint { color: #555; }
body.light .hint { color: #aaa; }

.controls:hover,
.speed-control:hover,
.hint:hover { opacity: 1; }

button {
  padding: 8px 16px;
  border: 2px solid currentColor;
  background: transparent;
  color: inherit;
  font-size: 14px;
  cursor: pointer;
  border-radius: 6px;
  transition: opacity 0.2s;
}
button:hover { opacity: 0.6; }
button.icon-btn { border: none; padding: 8px; }
button.active-mode {
  background: currentColor;
}
body.dark button.active-mode { color: #0a0a0a; background: #fff; }
body.light button.active-mode { color: #fafafa; background: #111; }

/* Help overlay */
.help-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.help-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}

.help-backdrop {
  position: absolute;
  inset: 0;
}

body.dark .help-backdrop { background: rgba(0,0,0,0.85); }
body.light .help-backdrop { background: rgba(255,255,255,0.9); }

.help-content {
  position: relative;
  max-width: 640px;
  width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  padding: 40px;
  border-radius: 12px;
  line-height: 1.8;
  font-size: 15px;
  user-select: text;
}

body.dark .help-content { background: #1a1a1a; color: #ddd; }
body.light .help-content { background: #fff; color: #222; border: 1px solid #ddd; }

.help-content h2 {
  font-size: 22px;
  margin-bottom: 20px;
  letter-spacing: 0.05em;
}

.help-content h3 {
  font-size: 16px;
  margin-top: 24px;
  margin-bottom: 8px;
  opacity: 0.6;
  letter-spacing: 0.1em;
}

.help-content p { margin-bottom: 12px; }

.help-content .etymology {
  font-size: 20px;
  font-weight: 700;
  margin: 16px 0;
  letter-spacing: 0.02em;
}

body.dark .help-content .etymology { color: #8bb8ff; }
body.light .help-content .etymology { color: #0044cc; }

.help-content .comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin: 16px 0;
}

.help-content .comparison > div {
  padding: 16px;
  border-radius: 8px;
}

body.dark .help-content .comparison > div { background: #252525; }
body.light .help-content .comparison > div { background: #f5f5f5; }

.help-content .comparison .label {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.15em;
  opacity: 0.5;
  margin-bottom: 6px;
}

.help-content .formula {
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  padding: 16px;
  margin: 16px 0;
  border-radius: 8px;
  letter-spacing: 0.05em;
}

body.dark .help-content .formula { background: #1f2a1f; color: #8bff8b; }
body.light .help-content .formula { background: #f0f7f0; color: #006600; }

.help-close {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 20px;
  cursor: pointer;
  opacity: 0.4;
  background: none;
  border: none;
  color: inherit;
  padding: 4px 8px;
}

.help-close:hover { opacity: 1; }

/* --- Mobile portrait --- */
@media (max-width: 600px) {
  .phrase {
    font-size: 8vw;
    padding: 0 6vw;
  }

  .timer {
    font-size: 28px;
    top: 12px;
    left: 12px;
  }

  .controls {
    top: auto;
    bottom: 16px;
    right: 50%;
    transform: translateX(50%);
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
    max-width: 90vw;
    opacity: 0.25;
  }

  .controls > span { display: none; }

  button {
    padding: 10px 14px;
    font-size: 13px;
  }

  .hint { display: none; }

  .speed-control { display: none; }

  .lb-label {
    font-size: 12px;
  }

  .lb-text {
    font-size: 7vw;
  }

  .lb-action {
    font-size: 9vw;
  }

  .eb-reveal {
    font-size: 8vw;
  }

  #nextBtn, #pauseBtn, #resetBtn { display: none; }

  .lb-counter {
    bottom: 130px;
    font-size: 14px;
  }

  .help-content {
    padding: 24px 20px;
    font-size: 14px;
  }

  .help-content .comparison {
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .help-content .etymology {
    font-size: 16px;
  }

  .help-content .formula {
    font-size: 16px;
  }
}
</style>
</head>
<body class="dark">

<div class="timer" id="timer">15:00</div>
<div class="progress-bar" id="progressBar"></div>

<div class="controls">
  <button id="modeEB" class="active-mode">EB</button>
  <button id="modeLB">LB折り</button>
  <span style="width:1px; background:currentColor; opacity:0.2;"></span>
  <button id="themeToggle" class="icon-btn" title="テーマ切替"><svg id="themeIcon" width="18" height="18" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="4"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41"/></svg></button>
  <button id="nextBtn" class="icon-btn" title="Next"><svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" stroke="none"><path d="M3 2l8 6-8 6V2z"/><rect x="12" y="2" width="2" height="12"/></svg></button>
  <button id="pauseBtn" class="icon-btn" title="Pause"><svg id="pauseIcon" width="18" height="18" viewBox="0 0 16 16" fill="currentColor" stroke="none"><rect x="3" y="2" width="3.5" height="12"/><rect x="9.5" y="2" width="3.5" height="12"/></svg></button>
  <button id="fullscreenBtn" class="icon-btn" title="Fullscreen"><svg width="18" height="18" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 5V1h4M11 1h4v4M15 11v4h-4M5 15H1v-4"/></svg></button>
  <button id="resetBtn" class="icon-btn" title="Reset"><svg width="18" height="18" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 8a6 6 0 0 1 10.3-4.2M14 8a6 6 0 0 1-10.3 4.2"/><path d="M12.3 1v3h-3M3.7 15v-3h3"/></svg></button>
  <span style="width:1px; background:currentColor; opacity:0.2;"></span>
  <button id="helpBtn" class="icon-btn" title="ヘルプ"><svg width="18" height="18" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6.5"/><path d="M5.5 6a2.5 2.5 0 0 1 4.5 1.5c0 1.5-2.5 1.5-2.5 3"/><circle cx="8" cy="12.5" r="0.5" fill="currentColor"/></svg></button>
</div>

<div class="speed-control" id="speedControl">
  <span>表示秒数</span>
  <input type="range" id="durationRange" min="2" max="10" value="3">
  <span id="durationLabel">3s</span>
</div>

<div class="hint" id="hint">
  Space: 一時停止 / N: 次へ / M: モード切替 / H: ヘルプ / T: テーマ切替 / F: 全画面 / R: リセット / ↑↓: 表示秒数
</div>

<!-- EB mode -->
<div class="phrase" id="phrase"></div>

<!-- LB mode -->
<div class="lb-container" id="lbContainer" style="display:none;">
  <div class="lb-label" id="lbLabel"></div>
  <div class="lb-text" id="lbText"></div>
  <div class="lb-action" id="lbAction"></div>
  <div class="eb-reveal" id="ebReveal"></div>
</div>
<div class="lb-counter" id="lbCounter" style="display:none;"></div>

<!-- Help overlay -->
<div class="help-overlay" id="helpOverlay">
  <div class="help-backdrop" id="helpBackdrop"></div>
  <div class="help-content">
    <button class="help-close" id="helpClose">&times;</button>
    <h2>Incantation とは</h2>

    <h3>語源</h3>
    <div class="etymology">
      ラテン語 "incantare" = in-（中へ）+ cantare（歌う）<br>
      「歌い込む」「唱え込む」
    </div>
    <p>英語圏では本来「呪文・魔法の詠唱」の意味。ハリー・ポッターの呪文も incantation。<br>
    アンソニー・ロビンズが、言葉を唱えることで現実を変える力を込めて、あえてこの強い言葉を選んだ。</p>

    <h3>アファメーションとの違い</h3>
    <div class="comparison">
      <div>
        <div class="label">AFFIRMATION</div>
        affirmare = 肯定する<br>
        頭で言い聞かせる
      </div>
      <div>
        <div class="label">INCANTATION</div>
        incantare = 歌い込む<br>
        <strong>身体・声・感情を総動員</strong>して信念を書き換える
      </div>
    </div>

    <h3>信念の形成</h3>
    <div class="formula">繰り返し + 感情 = 信念</div>
    <p>Be &rarr; Do &rarr; Have の法則: 「私は<strong>既に</strong>その状態である」から始める。</p>

    <h3>LB折りのプロセス</h3>
    <p>
      1. Limiting Belief を認識する<br>
      2. <strong>折ると決める</strong> &mdash; 決断が全て<br>
      3. <strong>折るのは簡単</strong> &mdash; 難しいという思い込みを外す<br>
      4. <strong>これはウソだ</strong> &mdash; 反証を見つけて証明する<br>
      5. Empowering Belief へ書き換える
    </p>

    <h3>実践目安</h3>
    <p>1日最低 <strong>20分</strong>。感情を伴わせて、身体を使って唱える。</p>
  </div>
</div>

<script>
// --- Data ---

const phrases = [
  "私は、動きながら完成させる人間だ。",
  "声をかけるたびに、新しい可能性が生まれる。",
  "私の知識と経験には、お金を払う価値がある。",
  "仕組みと仲間で、100倍の成果を出す。",
  "PM×AI×ナレッジ×教育——この掛け算が、私だけの武器だ。",
  "私はこれを実現できる。私は既にその道を歩いている。",
  "I'm outstanding partner. Yes!",
  "私は今、知を共有し、人の可能性をナッジする冒険の真っ只中にいる！",
  "共に学び成長する仲間が、私のまわりに集まっている！",
  "必要なものは全て、今、私の中に揃っている！",
  "私は今日、目の前の人に最大の貢献をする！",
  "私のビジョンに共鳴する仲間が5人、既に私を待っている！",
  "セールスは貢献だ。私は堂々と価値を届ける！",
];

const lbPairs = [
  // --- ワークで書き出した5つ ---
  {
    lb: "完璧にしてからでないと動けない",
    eb: "私は、動きながら完成させる人間だ。",
  },
  {
    lb: "声をかけるのが怖い、迷惑では",
    eb: "声をかけるたびに、新しい可能性が生まれる。",
  },
  {
    lb: "自分の知識や経験にお金を払う価値はない",
    eb: "私の知識と経験には、お金を払う価値がある。",
  },
  {
    lb: "全部一人でやらなければならない",
    eb: "仕組みと仲間で、100倍の成果を出す。",
  },
  {
    lb: "専門性が中途半端で武器がない",
    eb: "PM×AI×ナレッジ×教育——この掛け算が、私だけの武器だ。",
  },
  // --- 拡張 ---
  {
    lb: "売り込みは押し付けだ、嫌われる",
    eb: "セールスは貢献だ。私は堂々と価値を届ける！",
  },
  {
    lb: "私にはまだ何かが足りない",
    eb: "必要なものは全て、今、私の中に揃っている！",
  },
  {
    lb: "自分のビジョンに共感する人なんていない",
    eb: "私のビジョンに共鳴する仲間が5人、既に私を待っている！",
  },
  {
    lb: "失敗したら取り返しがつかない",
    eb: "私はこれを実現できる。私は既にその道を歩いている。",
  },
  {
    lb: "もう遅い、今さら始めても間に合わない",
    eb: "私は今、知を共有し、人の可能性をナッジする冒険の真っ只中にいる！",
  },
  {
    lb: "自分の発信なんて誰も読まない",
    eb: "共に学び成長する仲間が、私のまわりに集まっている！",
  },
  {
    lb: "忙しすぎて新しいことをする余裕がない",
    eb: "私は今日、目の前の人に最大の貢献をする！",
  },
];

// --- State ---

const TOTAL_SECONDS = 15 * 60;
let remainingSeconds = TOTAL_SECONDS;
let currentIndex = -1;
let isPaused = false;
let duration = 3;
let phraseTimerId = null;
let countdownId = null;
let karaokeAnimId = null;
let karaokeStart = 0;
let currentMode = "eb"; // "eb" or "lb"
let lbIndex = 0;
let lbStepTimers = [];

// --- Elements ---

const phraseEl = document.getElementById("phrase");
const timerEl = document.getElementById("timer");
const progressBar = document.getElementById("progressBar");
const themeToggle = document.getElementById("themeToggle");
const nextBtn = document.getElementById("nextBtn");
const pauseBtn = document.getElementById("pauseBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const resetBtn = document.getElementById("resetBtn");
const durationRange = document.getElementById("durationRange");
const durationLabel = document.getElementById("durationLabel");
const modeEB = document.getElementById("modeEB");
const modeLB = document.getElementById("modeLB");
const lbContainer = document.getElementById("lbContainer");
const lbLabel = document.getElementById("lbLabel");
const lbText = document.getElementById("lbText");
const lbAction = document.getElementById("lbAction");
const ebReveal = document.getElementById("ebReveal");
const lbCounter = document.getElementById("lbCounter");
const speedControl = document.getElementById("speedControl");
const helpOverlay = document.getElementById("helpOverlay");
const helpBtn = document.getElementById("helpBtn");
const helpClose = document.getElementById("helpClose");
const helpBackdrop = document.getElementById("helpBackdrop");

// --- Timer ---

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return m + ":" + String(s).padStart(2, "0");
}

function updateTimer() {
  timerEl.textContent = formatTime(remainingSeconds);
  const pct = ((TOTAL_SECONDS - remainingSeconds) / TOTAL_SECONDS) * 100;
  progressBar.style.width = pct + "%";
}

function tickCountdown() {
  if (remainingSeconds <= 0) {
    timerEl.textContent = "0:00";
    timerEl.classList.add("finished");
    progressBar.style.width = "100%";
    return;
  }
  countdownId = setInterval(() => {
    if (!isPaused && remainingSeconds > 0) {
      remainingSeconds--;
      updateTimer();
      if (remainingSeconds <= 0) {
        clearInterval(countdownId);
        timerEl.classList.add("finished");
      }
    }
  }, 1000);
}

function resetTimer() {
  clearInterval(countdownId);
  remainingSeconds = TOTAL_SECONDS;
  timerEl.classList.remove("finished");
  updateTimer();
  tickCountdown();
}

// =====================
// EB Mode (Karaoke)
// =====================

let charSpans = [];

function setPhrase(text) {
  phraseEl.innerHTML = "";
  charSpans = [];
  for (const ch of text) {
    const span = document.createElement("span");
    span.className = "ch";
    span.textContent = ch;
    phraseEl.appendChild(span);
    charSpans.push(span);
  }
}

function updateKaraokeChars(count) {
  for (let i = 0; i < charSpans.length; i++) {
    charSpans[i].classList.toggle("active", i < count);
  }
}

function startKaraoke() {
  if (karaokeAnimId) cancelAnimationFrame(karaokeAnimId);
  karaokeStart = performance.now();
  updateKaraokeChars(0);
  const total = charSpans.length;
  var pausedElapsed = 0;

  function tick(now) {
    if (isPaused) {
      karaokeStart = now - pausedElapsed;
      karaokeAnimId = requestAnimationFrame(tick);
      return;
    }
    const elapsed = now - karaokeStart;
    pausedElapsed = elapsed;
    const progress = Math.min(elapsed / (duration * 1000), 1);
    const count = Math.round(progress * total);
    updateKaraokeChars(count);
    if (progress < 1) {
      karaokeAnimId = requestAnimationFrame(tick);
    }
  }

  karaokeAnimId = requestAnimationFrame(tick);
}

function pickRandom() {
  let next;
  do {
    next = Math.floor(Math.random() * phrases.length);
  } while (next === currentIndex && phrases.length > 1);
  currentIndex = next;
  return phrases[currentIndex];
}

function showNextEB() {
  if (phraseTimerId) clearTimeout(phraseTimerId);
  if (karaokeAnimId) cancelAnimationFrame(karaokeAnimId);

  phraseEl.classList.remove("visible");

  setTimeout(() => {
    setPhrase(pickRandom());
    updateKaraokeChars(0);
    phraseEl.classList.add("visible");
    startKaraoke();

    if (!isPaused) {
      phraseTimerId = setTimeout(showNextEB, duration * 1000 + 1000);
    }
  }, 1000);
}

function resumeEBCycle() {
  if (phraseTimerId) clearTimeout(phraseTimerId);
  phraseTimerId = setTimeout(showNextEB, duration * 1000);
}

// =====================
// LB Mode (Break flow)
// =====================

function clearLBTimers() {
  lbStepTimers.forEach(t => clearTimeout(t));
  lbStepTimers = [];
}

function updateLBCounter() {
  lbCounter.textContent = (lbIndex + 1) + " / " + lbPairs.length;
}

function showLBSequence() {
  clearLBTimers();

  const pair = lbPairs[lbIndex];
  updateLBCounter();

  // Reset
  lbContainer.classList.remove("visible");
  lbText.classList.remove("struck");
  lbAction.classList.remove("visible");
  lbAction.className = "lb-action";
  lbAction.style.display = "";
  ebReveal.classList.remove("visible");
  ebReveal.textContent = "";

  // Step 1: Show LB
  lbStepTimers.push(setTimeout(() => {
    lbLabel.textContent = "LIMITING BELIEF";
    lbText.textContent = "「" + pair.lb + "」";
    lbAction.textContent = "";
    lbContainer.classList.add("visible");
  }, 300));

  // Step 2: "折ると決める。"
  lbStepTimers.push(setTimeout(() => {
    lbAction.textContent = "折ると決める。";
    lbAction.className = "lb-action break";
    lbAction.classList.add("visible");
  }, 3000));

  // Step 3: "折るのは簡単。"
  lbStepTimers.push(setTimeout(() => {
    lbAction.classList.remove("visible");
    setTimeout(() => {
      lbAction.textContent = "折るのは簡単。";
      lbAction.className = "lb-action easy";
      lbAction.classList.add("visible");
    }, 400);
  }, 5500));

  // Step 4: "これはウソだ。" + strikethrough
  lbStepTimers.push(setTimeout(() => {
    lbAction.classList.remove("visible");
    setTimeout(() => {
      lbAction.textContent = "これはウソだ。";
      lbAction.className = "lb-action lie";
      lbAction.classList.add("visible");
      lbText.classList.add("struck");
    }, 400);
  }, 8000));

  // Step 5: Show EB
  lbStepTimers.push(setTimeout(() => {
    lbLabel.textContent = "EMPOWERING BELIEF";
    lbAction.classList.remove("visible");
    lbAction.style.display = "none";
    ebReveal.textContent = pair.eb;
    ebReveal.classList.add("visible");
  }, 11000));

  // Step 6: Next LB
  lbStepTimers.push(setTimeout(() => {
    lbIndex = (lbIndex + 1) % lbPairs.length;
    showLBSequence();
  }, 15000));
}

function showNextLB() {
  lbIndex = (lbIndex + 1) % lbPairs.length;
  showLBSequence();
}

// =====================
// Mode switching
// =====================

function stopCurrentMode() {
  // Stop EB
  if (phraseTimerId) clearTimeout(phraseTimerId);
  if (karaokeAnimId) cancelAnimationFrame(karaokeAnimId);
  phraseEl.classList.remove("visible");

  // Stop LB
  clearLBTimers();
  lbContainer.classList.remove("visible");
}

function switchMode(mode) {
  if (mode === currentMode) return;
  stopCurrentMode();
  currentMode = mode;

  if (mode === "eb") {
    modeEB.classList.add("active-mode");
    modeLB.classList.remove("active-mode");
    phraseEl.style.display = "";
    lbContainer.style.display = "none";
    lbCounter.style.display = "none";
    speedControl.style.display = "";
    showNextEB();
  } else {
    modeLB.classList.add("active-mode");
    modeEB.classList.remove("active-mode");
    phraseEl.style.display = "none";
    lbContainer.style.display = "";
    lbCounter.style.display = "";
    speedControl.style.display = "none";
    lbIndex = 0;
    showLBSequence();
  }
}

// --- Controls ---

modeEB.addEventListener("click", () => switchMode("eb"));
modeLB.addEventListener("click", () => switchMode("lb"));

themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  document.body.classList.toggle("light");
  const isDark = document.body.classList.contains("dark");
  document.getElementById("themeIcon").innerHTML = isDark
    ? '<circle cx="8" cy="8" r="4"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41"/>'
    : '<path d="M13.5 8a5.5 5.5 0 0 1-8.44 4.65A5.5 5.5 0 0 1 9.35 2.5 5.5 5.5 0 0 0 13.5 8z"/>';
});

nextBtn.addEventListener("click", () => {
  if (currentMode === "eb") showNextEB();
  else showNextLB();
});

pauseBtn.addEventListener("click", () => {
  isPaused = !isPaused;
  document.getElementById("pauseIcon").innerHTML = isPaused
    ? '<path d="M4 2l10 6-10 6V2z"/>'
    : '<rect x="3" y="2" width="3.5" height="12"/><rect x="9.5" y="2" width="3.5" height="12"/>';
  if (currentMode === "eb") {
    if (isPaused) {
      if (phraseTimerId) clearTimeout(phraseTimerId);
    } else {
      resumeEBCycle();
    }
  }
});

fullscreenBtn.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
});

resetBtn.addEventListener("click", resetTimer);

function toggleHelp() {
  helpOverlay.classList.toggle("visible");
}
helpBtn.addEventListener("click", toggleHelp);
helpClose.addEventListener("click", toggleHelp);
helpBackdrop.addEventListener("click", toggleHelp);

durationRange.addEventListener("input", (e) => {
  duration = parseInt(e.target.value, 10);
  durationLabel.textContent = duration + "s";
});

// --- Keyboard shortcuts ---

document.addEventListener("keydown", (e) => {
  switch (e.key) {
    case " ":
      e.preventDefault();
      pauseBtn.click();
      break;
    case "n": case "N":
      if (currentMode === "eb") showNextEB();
      else showNextLB();
      break;
    case "m": case "M":
      switchMode(currentMode === "eb" ? "lb" : "eb");
      break;
    case "h": case "H": case "?":
      toggleHelp();
      break;
    case "Escape":
      if (helpOverlay.classList.contains("visible")) toggleHelp();
      break;
    case "t": case "T":
      themeToggle.click();
      break;
    case "f": case "F":
      fullscreenBtn.click();
      break;
    case "r": case "R":
      resetTimer();
      break;
    case "ArrowUp":
      duration = Math.min(duration + 1, 10);
      durationRange.value = duration;
      durationLabel.textContent = duration + "s";
      break;
    case "ArrowDown":
      duration = Math.max(duration - 1, 2);
      durationRange.value = duration;
      durationLabel.textContent = duration + "s";
      break;
  }
});

// --- Touch: tap to advance ---
document.body.addEventListener("click", (e) => {
  if (e.target.closest(".controls, .speed-control, .help-overlay, button, input")) return;
  if (currentMode === "eb") showNextEB();
  else showNextLB();
});

// --- Start ---
updateTimer();
tickCountdown();
showNextEB();
</script>
</body>
</html>
